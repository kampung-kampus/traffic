<!DOCTYPE html>

<html>

<head>

  <title>Singapore Causeway Traffic</title>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>

    #map { height: 100vh; }



    .info.legend {

      background: white;

      padding: 10px;

      font-size: 14px;

      line-height: 1.5;

      border-radius: 5px;

      box-shadow: 0 0 10px rgba(0,0,0,0.2);

    }



    .info button {

      padding: 6px 12px;

      font-size: 13px;

      border: none;

      background-color: #007bff;

      color: white;

      border-radius: 4px;

      cursor: pointer;

    }



    .info button:hover {

      background-color: #0056b3;

    }

  </style>

</head>

<body>



 

  <div id="map"></div>



  <!-- Leaflet JS -->

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>

// declare a global value

let timestampDiv;

let legendControl;

// View mode: 'heatmap' or 'polyline'

let currentViewMode = 'polyline'; // Start with polyline view

let heatmapLayer = null;

let viewToggleButton = null;
    // Initialize map centered on Woodlands Checkpoint

    const map = L.map('map').setView([1.445, 103.768], 15);



    // Add OpenStreetMap tiles 

     L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19,attribution: '© OpenStreetMap'}).addTo(map);

    

    // Speed band color logic - 4 bands

    function getColor(speedBand) {

      // Map SpeedBand to 4 color categories

      if (speedBand === 1) {

        return '#ab1121'; // Red: 0-10 km/h

      } else if (speedBand === 2 || speedBand === 3) {

        return '#f27e57'; // Orange: 11-30 km/h

      } else if (speedBand === 4 || speedBand === 5) {

        return '#fafaa2'; // Yellow: 31-50 km/h

      } else if (speedBand === 6 || speedBand === 7) {

        return '#82e681'; // Green: >51 km/h

      } else {

        return '#999'; // Default gray

      }

    }



    // Modular Traffic Layer Refresh - separate layers for heatmap and polylines

 let polylineLayerGroup = L.layerGroup();

 let heatmapLayerGroup = L.layerGroup();

 

 // Add initial layer based on current view mode

 if (currentViewMode === 'polyline') {

   polylineLayerGroup.addTo(map);

 } else {

   heatmapLayerGroup.addTo(map);

 }



function updateTimestamp() {

  if (timestampDiv) {

    const now = new Date();

    timestampDiv.innerHTML = `Last updated: ${now.toLocaleString('en-SG', { hour12: false })}`;

  }

}

function loadTrafficData() {

  // Update timestamp immediately when starting the fetch

  updateTimestamp();

  

  fetch('https://datamall2.mytransport.sg/ltaodataservice/TrafficSpeedBands', {

    method: 'GET',

    headers: {

      'AccountKey': '325y4IwcQU+mqCX5P+D01g==',

      'accept': 'application/json'

    }

  })

  .then(response => response.json())

  .then(data => {

    console.log('Traffic data received:', data.value ? data.value.length : 0, 'segments');

    

    // Clear both layers

    polylineLayerGroup.clearLayers();

    heatmapLayerGroup.clearLayers();

    

    const heatPoints = [];

    let segmentCount = 0;



    data.value.forEach(segment => {

      const lat1 = parseFloat(segment.StartLat);

      const lon1 = parseFloat(segment.StartLon);

      const lat2 = parseFloat(segment.EndLat);

      const lon2 = parseFloat(segment.EndLon);



      if (lat1 > 1.44 && lat1 < 1.446 && lon1 > 103.765 && lon1 < 103.77) {

        segmentCount++;

        

        // Add polyline to polyline layer group

        L.polyline([[lat1, lon1], [lat2, lon2]], {

          color: getColor(segment.SpeedBand),

          weight: 6,

          opacity: 0.8

        }).bindPopup(`

          <strong>${segment.RoadName}</strong><br>

          Speed: ${segment.MinimumSpeed}–${segment.MaximumSpeed} km/h<br>

          Speed Band: ${segment.SpeedBand}

        `).addTo(polylineLayerGroup);



        // Add heat point with higher intensity for better visibility

        const intensity = (8 - segment.SpeedBand) * 0.3; // Scale intensity

        heatPoints.push([lat1, lon1, intensity]);

      }

    });



    console.log('Segments in view area:', segmentCount);

    console.log('Heat points created:', heatPoints.length);

    console.log('Current view mode:', currentViewMode);



    // Create heatmap layer

    if (heatPoints.length > 0) {

      // Remove old heatmap layer if it exists

      if (heatmapLayer) {

        heatmapLayerGroup.removeLayer(heatmapLayer);

      }

      // Create new heatmap layer with enhanced visibility

      heatmapLayer = L.heatLayer(heatPoints, {

        radius: 40,  // Increased from 25 for better visibility

        blur: 20,    // Increased from 15

        maxZoom: 17,

        minOpacity: 0.3  // Minimum opacity for better visibility

      });

      heatmapLayerGroup.addLayer(heatmapLayer);

      console.log('Heatmap layer created');

    } else {

      console.warn('No heat points to display');

    }

    

    // Update view based on current mode

    updateViewMode();

    console.log('View updated. Polyline layer on map:', map.hasLayer(polylineLayerGroup), 'Heatmap layer on map:', map.hasLayer(heatmapLayerGroup));

  })

  .catch(error => {

    console.error('Error fetching traffic data:', error);

    console.error('Error details:', error.message);

    // Update timestamp even on error to show when the last attempt was made

    updateTimestamp();

  });

}



    //refresh every 60 seconds without reloading the page

    

setInterval(() => {

  loadTrafficData();

}, 60000);



  

   // Add legend - 4 speed bands

    legendControl = L.control({ position: 'bottomright' });

    legendControl.onAdd = function () {

      const div = L.DomUtil.create('div', 'info legend');

      div.id = 'legend-box';

      // Define 4 speed bands with colors and labels

      const speedBands = [

        { label: '0–10 km/h', color: '#ab1121' },      // Red

        { label: '11–30 km/h', color: '#f27e57' },     // Orange

        { label: '31–50 km/h', color: '#fafaa2' },     // Yellow

        { label: '>51 km/h', color: '#82e681' }        // Green

      ];

      const labels = speedBands.map(band => {

        return `<i style="background:${band.color}; width:18px; height:18px; display:inline-block; margin-right:8px; border:1px solid #ccc;"></i>${band.label}`;

      });

      div.innerHTML = `<strong>Speed Bands</strong><br>${labels.join('<br>')}`;

      return div;

    };

    legendControl.addTo(map);



    // Add checkpoint markers

    L.marker([1.445, 103.768]).addTo(map).bindPopup("Woodlands Checkpoint");

    L.marker([1.462, 103.763]).addTo(map).bindPopup("Johor Bahru CIQ");



    // Add legend toggle button

    const legendToggle = L.control({ position: 'topright' });

    legendToggle.onAdd = function () {

      const div = L.DomUtil.create('div', 'info');

      div.innerHTML = '<button onclick="toggleLegend()">Toggle Legend</button>';

      return div;

    };

    legendToggle.addTo(map);



    // Add view toggle button (heatmap/polyline)

    const viewToggle = L.control({ position: 'topright' });

    viewToggle.onAdd = function () {

      const div = L.DomUtil.create('div', 'info');

      viewToggleButton = document.createElement('button');

      viewToggleButton.innerHTML = currentViewMode === 'polyline' ? 'Show Heatmap' : 'Show Polylines';

      viewToggleButton.style.cssText = 'padding: 6px 12px; font-size: 13px; border: none; background-color: #28a745; color: white; border-radius: 4px; cursor: pointer; margin-top: 5px; width: 100%;';

      viewToggleButton.onmouseover = function() { this.style.backgroundColor = '#218838'; };

      viewToggleButton.onmouseout = function() { this.style.backgroundColor = '#28a745'; };

      viewToggleButton.onclick = toggleViewMode;

      div.appendChild(viewToggleButton);

      return div;

    };

    viewToggle.addTo(map);



  function toggleLegend() {

    const legendDiv = document.getElementById('legend-box');

    if (legendDiv) {

      // Get the Leaflet control container (parent of the legend div)

      const container = legendDiv.parentElement;

      if (container) {

        // Toggle the container's visibility

        if (container.style.display === 'none') {

          container.style.display = '';

        } else {

          container.style.display = 'none';

        }

      }

    }

  }

  

  function toggleViewMode() {

    // Switch view mode

    currentViewMode = currentViewMode === 'polyline' ? 'heatmap' : 'polyline';

    console.log('Toggling to:', currentViewMode);

    

    // Update the view

    updateViewMode();

    

    // Update button text

    if (viewToggleButton) {

      viewToggleButton.innerHTML = currentViewMode === 'polyline' ? 'Show Heatmap' : 'Show Polylines';

    }

  }

  

  function updateViewMode() {

    if (currentViewMode === 'polyline') {

      // Show polylines, hide heatmap

      if (map.hasLayer(heatmapLayerGroup)) {

        map.removeLayer(heatmapLayerGroup);

      }

      if (!map.hasLayer(polylineLayerGroup)) {

        polylineLayerGroup.addTo(map);

      }

      console.log('Polyline view active');

    } else {

      // Show heatmap, hide polylines

      if (map.hasLayer(polylineLayerGroup)) {

        map.removeLayer(polylineLayerGroup);

      }

      if (!map.hasLayer(heatmapLayerGroup)) {

        heatmapLayerGroup.addTo(map);

      }

      console.log('Heatmap view active');

    }

  }
// Add timestamp control styled like legend

const timestampControl = L.control({ position: 'bottomleft' });

timestampControl.onAdd = function () {

  timestampDiv = L.DomUtil.create('div', 'info legend');

  timestampDiv.id = 'map-timestamp';

  // Set initial timestamp immediately

  const now = new Date();

  timestampDiv.innerHTML = `Last updated: ${now.toLocaleString('en-SG', { hour12: false })}`;

  return timestampDiv;

};

timestampControl.addTo(map);

  

// Call script once on load

 setTimeout(loadTrafficData, 100);

  </script>

</body>

</html>












